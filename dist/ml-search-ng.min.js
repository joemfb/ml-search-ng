function MLRemoteSearchController(t,e,r,n){"use strict";return this instanceof MLRemoteSearchController?(MLSearchController.call(this,t,e,r),void(this.remoteInput=n)):new MLRemoteSearchController(t,e,r,n)}function MLSearchController(t,e,r){"use strict";return this instanceof MLSearchController?(this.$scope=t,this.$location=e,this.mlSearch=r,this.searchPending=!1,this.page=1,this.qtext="",void(this.response={})):new MLSearchController(t,e,r)}!function(){"use strict";angular.module("ml.search",["ml.common"]).constant("ml.search.version","0.2.5")}();var superCtrl=MLSearchController.prototype;MLRemoteSearchController.prototype=Object.create(superCtrl),function(){"use strict";MLRemoteSearchController.prototype.init=function(){var t=this,e=this.remoteInput.subscribe(function(e){t.qtext!==e&&(t.qtext=e,t.search())});return this.remoteInput.mlSearch=this.mlSearch,this.qtext=this.remoteInput.input,this.$scope.$on("$destroy",e),superCtrl.init.apply(this,arguments)},MLRemoteSearchController.prototype.updateSearchResults=function(t){return superCtrl.updateSearchResults.apply(this,arguments),this.remoteInput.setInput(this.qtext),this}}(),function(){"use strict";MLSearchController.prototype.init=function(){return this.$scope.$on("$locationChangeSuccess",this.locationChange.bind(this)),this.parseExtraURLParams&&this.parseExtraURLParams(),this.mlSearch.fromParams().then(this._search.bind(this))},MLSearchController.prototype.locationChange=function(t,e,r){var n=this,s=!1;return this.parseExtraURLParams&&(s=this.parseExtraURLParams()),this.mlSearch.locationChange(e,r).then(this._search.bind(this),function(){s&&n._search()})},MLSearchController.prototype._search=function(){this.searchPending=!0;var t=this.mlSearch.search().then(this.updateSearchResults.bind(this));return this.updateURLParams(),t},MLSearchController.prototype.updateSearchResults=function(t){return this.searchPending=!1,this.response=t,this.qtext=this.mlSearch.getText(),this.page=this.mlSearch.getPage(),this},MLSearchController.prototype.updateURLParams=function(){var t=_.chain(this.$location.search()).omit(this.mlSearch.getParamsKeys()).merge(this.mlSearch.getParams()).value();return this.$location.search(t),this.updateExtraURLParams&&this.updateExtraURLParams(),this},MLSearchController.prototype.search=function(t){return arguments.length&&(this.qtext=t),this.mlSearch.setText(this.qtext).setPage(this.page),this._search()},MLSearchController.prototype.reset=function(){return this.mlSearch.clearAllFacets().clearAdditionalQueries().clearBoostQueries(),this.qtext="",this.page=1,this._search()},MLSearchController.prototype.toggleFacet=function(t,e){return this.mlSearch.toggleFacet(t,e),this._search()},MLSearchController.prototype.toggleNegatedFacet=function(t,e){return this.mlSearch.toggleFacet(t,e,!0),this._search()},MLSearchController.prototype.showMoreFacets=function(t,e,r){return this.mlSearch.showMoreFacets(t,e,r)},MLSearchController.prototype.clearFacets=function(){return this.mlSearch.clearAllFacets(),this._search()},MLSearchController.prototype.suggest=function(t,e){return this.mlSearch.suggest(t,e).then(function(t){return t.suggestions||[]})}}(),function(){"use strict";function t(){return{restrict:"E",scope:{activeFacets:"=",toggle:"&"},templateUrl:e,link:r}}function e(t,e){var r;return r=e.template?e.template:"/templates/ml-chiclets.html"}function r(t,e,r){t.truncateLength=parseInt(r.truncate,10)||20}angular.module("ml.search").directive("mlChiclets",t)}(),function(){"use strict";function t(){return function(t,e){t=_.isObject(t)?t:n(t);var r=[],s={year:"year",years:"years",month:"month",months:"months",week:"week",weeks:"weeks",day:"day",days:"days",hour:"hour",hours:"hours",minute:"minute",minutes:"minutes",second:"second",seconds:"seconds"};if(angular.extend(s,e),_.each(["year","month","week","day","hour","minute","second"],function(e){var n=e+"s";t[n]&&r.push(t[n]+" "+(t[n]>1?s[n]:s[e]))}),r.length>1){var a=r.splice(r.length-1,1);return r=r.join(", ")+", and "+a[0]}return r[0]||"0 seconds"}}function e(){return{restrict:"A",transclude:!0,scope:{mlDuration:"="},link:r}}function r(t,e,r,s,a){t.$watch("mlDuration",function(e,r){e&&angular.extend(t,{duration:n(e)})}),a(t,function(t){e.append(t)})}function n(t){var e=["P(","(([0-9]*\\.?[0-9]*)Y)?","(([0-9]*\\.?[0-9]*)M)?","(([0-9]*\\.?[0-9]*)W)?","(([0-9]*\\.?[0-9]*)D)?",")?","(T","(([0-9]*\\.?[0-9]*)H)?","(([0-9]*\\.?[0-9]*)M)?","(([0-9]*\\.?[0-9]*)S)?",")?"],r=new RegExp(e.join("")),n=t.match(r);return{years:parseFloat(n[3])||null,months:parseFloat(n[5])||null,weeks:parseFloat(n[7])||null,days:parseFloat(n[9])||null,hours:parseFloat(n[12])||null,minutes:parseFloat(n[14])||null,seconds:parseFloat(n[16])||null,toString:function(){return t}}}angular.module("ml.search").filter("duration",t).directive("mlDuration",e)}(),function(){"use strict";function t(){return{restrict:"E",controller:"mlFacetsController",scope:{activeFacets:"=",facets:"=",toggle:"&",negate:"&",showMore:"&"},templateUrl:e,link:r}}function e(t,e){var r;return r=e.template?"inline"===e.template?"/templates/ml-facets-inline.html":e.template:"/templates/ml-facets.html"}function r(t,e,r){t.truncateLength=parseInt(r.truncate,10)||20,t.shouldShowMore=!!r.showMore,t.shouldNegate=!!r.negate&&!!r.activeFacets}function n(t,e){t.filter=e("filter")}angular.module("ml.search").directive("mlFacets",t).controller("mlFacetsController",["$scope","$filter",n])}(),function(){"use strict";function t(){return{restrict:"E",scope:{qtext:"=",search:"&",suggest:"&"},templateUrl:e,link:r}}function e(t,e){var r;return r=e.template?"fa"===e.template?"/templates/ml-input-fa.html":e.template:"/templates/ml-input.html"}function r(t,e){t.clear=function(){t.search({qtext:""})}}angular.module("ml.search").directive("mlInput",t)}(),function(){"use strict";function t(t){return n=t,{restrict:"E",replace:!0,transclude:!0,templateUrl:"/templates/ml-metrics.html",scope:{search:"=",showDuration:"=?"},link:e}}function e(t,e,n,s,a){void 0===t.showDuration&&(t.showDuration=!0),t.$watch("search",function(e){angular.extend(t,r(e))}),a(t,function(t){t.length&&e.replaceWith(t)})}function r(t){return{total:t.total,start:t.start,pageLength:t["page-length"],pageEnd:n.Math.min(t.start+t["page-length"]-1,t.total),metrics:t.metrics}}angular.module("ml.search").directive("mlMetrics",t);var n=null;t.$inject=["$window"]}(),function(){"use strict";function t(){return{restrict:"E",controller:"MLRemoteInputController",scope:{searchCtrl:"@",template:"@"},template:e}}function e(t,e){var r="";return e.template&&(r=' template="'+e.template+'"'),'<ml-input qtext="qtext" search="search(qtext)" suggest="suggest(val)"'+r+"></ml-input>"}function r(t,e,r,n){var s,a=r.newContext();t.qtext=n.input,n.initInput(t,a),t.$watch("searchCtrl",function(e){var r=s;e=e||"SearchCtrl",s=n.getPath(e),r&&s!==r&&t.search("")}),t.search=function(t){e.path(s),n.setInput(t)},t.suggest=function(t){return a=n.mlSearch||a,a.suggest(t).then(function(t){return t.suggestions||[]})}}angular.module("ml.search").directive("mlRemoteInput",t).controller("MLRemoteInputController",r),r.$inject=["$scope","$location","MLSearchFactory","MLRemoteInputService"]}(),function(){"use strict";function t(){return{restrict:"E",scope:{results:"=",click:"&",link:"&",label:"&"},templateUrl:e,link:r}}function e(t,e){var r;return r=e.template?e.template:"/templates/ml-results.html"}function r(t,e,r){t.shouldClick=!!r.click,r.link||(t.link=function(t){return"/detail?uri="+encodeURIComponent(t.result.uri)}),r.label||(t.label=function(t){return _.last(t.result.uri.split("/"))}),t.$watch("results",function(e,r){_.each(e,function(e){e.link=t.link({result:e}),e.label=t.label({result:e})})})}angular.module("ml.search").directive("mlResults",t)}(),function(){"use strict";function t(t){function e(t){r.callbacks.splice(t)}var r=this,n=null;this.routeAvailable=!0;try{n=t.get("$route")}catch(s){this.routeAvailable=!1}r.input="",r.mlSearch=null,r.callbacks=[],r.setInput=function(t){r.input=t,_.each(r.callbacks,function(t){t(r.input)})},r.subscribe=function(t){var n=r.callbacks.length;return r.callbacks.push(t),function(){e(n)}},r.initInput=function(t,e){var n=r.subscribe(function(n){t.qtext=n,e=r.mlSearch||e});t.$on("destroy",n)},r.initCtrl=function(t,e,n,s){var a=r.subscribe(function(t){e.qtext!==t&&(e.qtext=t,s())});t.$on("$destroy",a),r.mlSearch=n,e.qtext.length&&!r.input.length?r.setInput(e.qtext):e.qtext=r.input},r.getPath=function(t){var e={originalPath:"/"},r=null;return null===n?null:(r=_.where(n.routes,{controller:t}),0===r.length?console.error("can't find Search controller: "+t):(e=r[0],r.length>1&&console.log("multiple Search controller routes; choosing '"+e.originalPath+"'")),e.originalPath)}}angular.module("ml.search").service("MLRemoteInputService",t),t.$inject=["$injector"]}(),function(){"use strict";function t(t,r,n,s){return o=t,u=r,c=n,l=s,{newContext:function(t){return new e(t)}}}function e(t){this.qb=l,this.results={},this.storedOptions={},this.activeFacets={},this.namespaces={},this.boostQueries=[],this.additionalQueries=[],this.searchTransform=null,this.qtext=null,this.start=1,this.options=_.merge(_.cloneDeep(this.defaults),t)}function r(t){return decodeURIComponent(t.replace(/\+/g,"%20"))}function n(t,e){function r(t){var e=document.createElement("a");return e.href=t,e.pathname}return r(t)===r(e)}function s(t,e){return t&&t.options&&t.options.constraint&&_.where(i(t.options.constraint),{name:e})[0]}function a(t){var e={constraint:i(t),values:i(_.cloneDeep(t))};return e.values[0]["values-option"]=t.range&&t.range["facet-option"],e}function i(){var t;return t=1===arguments.length?Array.isArray(arguments[0])?arguments[0]:[arguments[0]]:[].slice.call(arguments)}var o=null,u=null,c=null,l=null;angular.module("ml.search").factory("MLSearchFactory",t),t.$inject=["$q","$location","MLRest","MLQueryBuilder"],angular.extend(e.prototype,{defaults:{queryOptions:"all",suggestOptions:null,pageLength:10,snippet:"compact",sort:null,facetMode:"and",includeProperties:!1,includeAggregates:!1,params:{separator:":",qtext:"q",facets:"f",negatedFacets:"n",sort:"s",page:"p",prefix:null,prefixSeparator:null}},getActiveFacets:function(){return this.activeFacets},getNamespacePrefix:function(t){return this.namespaces[t]},getNamespaceUri:function(t){return _.chain(this.namespaces).map(function(e,r){return t===e?r:void 0}).compact().first().value()},getNamespaces:function(){var t=[];return _.forIn(this.namespaces,function(e,r){t.push({prefix:e,uri:r})}),t},setNamespaces:function(t){return _.each(t,this.addNamespace,this),this},addNamespace:function(t){return this.namespaces[t.uri]=t.prefix,this},clearNamespaces:function(){return this.namespaces={},this},getBoostQueries:function(){return this.boostQueries},addBoostQuery:function(t){return this.boostQueries.push(t),this},clearBoostQueries:function(){return this.boostQueries=[],this},getAdditionalQueries:function(){return this.additionalQueries},addAdditionalQuery:function(t){return this.additionalQueries.push(t),this},clearAdditionalQueries:function(){return this.additionalQueries=[],this},getTransform:function(t){return this.searchTransform},setTransform:function(t){return this.searchTransform=t,this},getText:function(){return this.qtext},setText:function(t){return""!==t?this.qtext=t:this.qtext=null,this},getPage:function(){var t=Math.floor(this.start/this.options.pageLength)+1;return t},setPage:function(t){return t=parseInt(t,10)||1,this.start=1+(t-1)*this.options.pageLength,this},getQueryOptions:function(){return this.options.queryOptions},getSuggestOptions:function(){return this.options.suggestOptions},getPageLength:function(){return this.options.pageLength},setPageLength:function(t){return this.options.pageLength=t,this},getSnippet:function(){return this.options.snippet},setSnippet:function(t){return this.options.snippet=t,this},clearSnippet:function(){return this.options.snippet=this.defaults.snippet,this},getSort:function(){return this.options.sort},setSort:function(t){return this.options.sort=t,this},clearSort:function(){return this.options.sort=this.defaults.sort,this},getFacetMode:function(){return this.options.facetMode},setFacetMode:function(t){return this.options.facetMode=t,this},getParamsConfig:function(){return this.options.params},getParamsKeys:function(){var t=this.getParamsPrefix();return _.chain(this.options.params).omit(["separator","prefix","prefixSeparator"]).map(function(e){return t+e}).compact().value()},getParamsPrefix:function(){var t="";return null!==this.options.params.prefix&&(t=this.options.params.prefix+(this.options.params.prefixSeparator||this.options.params.separator)),t},getQuery:function(){var t=l.and();return _.keys(this.activeFacets).length&&(t=this.getFacetQuery()),this.boostQueries.length&&(t=l.boost(t,this.boostQueries)),this.additionalQueries.length&&(t=l.and(t,this.additionalQueries)),this.options.includeProperties&&(t=l.or(t,l.propertiesFragment(t))),t=l.where(t),this.options.sort&&t.query.queries.push(l.ext.operatorState("sort",this.options.sort)),this.options.snippet&&t.query.queries.push(l.ext.operatorState("results",this.options.snippet)),t},getFacetQuery:function(){var t,e=this,r=[],n={};return _.forIn(e.activeFacets,function(e,n){e.values.length&&(t=function(t){var r=l.ext.constraint(e.type)(n,t.value);return t.negated===!0&&(r=l.not(r)),r},r=r.concat(_.map(e.values,t)))}),n="or"===e.options.facetMode?l.or(r):l.and(r)},getCombinedQuerySync:function(t){return l.ext.combined(this.getQuery(),this.getText(),t)},getCombinedQuery:function(t){var e=this.getCombinedQuerySync();return t?this.getStoredOptions().then(function(t){return e.search.options=t.options,e}):o.resolve(e)},isFacetActive:function(t,e){var r=this.activeFacets[t];return!!r&&!!_.find(r.values,{value:e})},isFacetNegated:function(t,e){var r=this.activeFacets[t];if(!r)return!1;var n=_.find(r.values,{value:e});return n?n.negated:!1},selectFacet:function(t,e,r,n){/^"(.*)"$/.test(e)&&(e=e.replace(/^"(.*)"$/,"$1"));var s=this.activeFacets[t],a=n||!1,i={value:e,negated:a};return s&&!this.isFacetActive(t,e)?s.values.push(i):this.activeFacets[t]={type:r,values:[i]},this},clearFacet:function(t,e){var r=this.activeFacets[t];return r.values=_.filter(r.values,function(t){return t.value!==e}),r.values.length||delete this.activeFacets[t],this},toggleFacet:function(t,e,r){var n;return this.isFacetActive(t,e)?this.clearFacet(t,e):(n=this.getFacetConfig(t),this.selectFacet(t,e,n.type,r)),this},clearAllFacets:function(){return this.activeFacets={},this},showMoreFacets:function(t,e,r){if(t.displayingAll)return o.resolve();r=r||5;var n=t.facetValues.length+1,s=n+r-1;return this.valuesFromConstraint(e,{start:n,limit:s}).then(function(e){var r=e&&e["values-response"]&&e["values-response"]["distinct-value"];return t.displayingAll=!r||r.length<s-n,_.each(r,function(e){t.facetValues.push({name:e._value,value:e._value,count:e.frequency})}),t})},getParams:function(){var t=this.getPage(),e=this.getFacetParams(),r=e.facets,n=e.negatedFacets,s={},a=this.getParamsPrefix();return r.length&&null!==this.options.params.facets&&(s[a+this.options.params.facets]=r),n.length&&null!==this.options.params.negatedFacets&&(s[a+this.options.params.negatedFacets]=n),t>1&&null!==this.options.params.page&&(s[a+this.options.params.page]=t),this.qtext&&null!==this.options.params.qtext&&(s[a+this.options.params.qtext]=this.qtext),this.options.sort&&null!==this.options.params.sort&&(s[a+this.options.params.sort]=this.options.sort),s},getFacetParams:function(){var t=this,e=t.getFacetQuery(),r=[],n={facets:[],negatedFacets:[]};return r=(e["or-query"]||e["and-query"]).queries,_.each(r,function(e){var r,s,a,i=_.keys(e)[0];"not-query"===i?(r=e[i][_.keys(e[i])[0]],a=n.negatedFacets):(r=e[i],a=n.facets),s=r["constraint-name"],_.each(r.value||r.uri||r.text,function(e){/\s+/.test(e)&&!/^"(.*)"$/.test(e)&&(e='"'+e+'"'),a.push(s+t.options.params.separator+e)})}),n},getCurrentParams:function(t){var e=this.getParamsPrefix();return t=_.pick(t||u.search(),this.getParamsKeys()),_.chain(this.options.params).pick(["facets","negatedFacets"]).values().each(function(r){var n=e+r;t[n]&&(t[n]=i(t[n]))}).value(),t},fromParams:function(t){var e=this,r=this.options.params,n=null,s=null,a=null;return t=this.getCurrentParams(t),this.fromParam(r.qtext,t,this.setText.bind(this),this.setText.bind(this,null)),this.fromParam(r.page,t,this.setPage.bind(this),this.setPage.bind(this,1)),this.fromParam(r.sort,t,this.setSort.bind(this)),e.clearAllFacets(),n=this.fromParam(r.facets,t,_.identity),s=this.fromParam(r.negatedFacets,t,_.identity),n||s?(a=e.results.facets?o.resolve(void 0):e.getStoredOptions(),a.then(function(t){n&&e.fromFacetParam(n,t),s&&e.fromFacetParam(s,t,!0)})):o.resolve()},fromParam:function(t,e,n,s){var a=this.getParamsPrefix()+t,i=e[a];if(null!==t)return i?(_.isString(i)&&(i=r(i)),n.call(this,i)):void(s&&s.call(this))},fromFacetParam:function(t,e,n){var s=this,a=_.map(i(t),r),o=n||!1;_.each(a,function(t){var r=t.split(s.options.params.separator),n=r[0],a=r[1],i=s.getFacetConfig(n,e)||{};i.type||console.error("don't have facets or options for '"+n+"', falling back to un-typed range queries"),s.selectFacet(n,a,i.type,o)})},getFacetConfig:function(t,e){var r=null;return e?(r=_.chain(e.options.constraint).where({name:t}).first().clone().value(),r.type=r.collection?"collection":r.custom?"custom":r.range.type):this.results.facets&&this.results.facets[t]&&(r=this.results.facets[t]),r},locationChange:function(t,e,r){r=this.getCurrentParams(r);var s=n(t,e)&&!_.isEqual(this.getParams(),r);return s?this.fromParams(r):o.reject()},getStoredOptions:function(t){var e=this;return t=t||this.getQueryOptions(),this.storedOptions[t]?o.resolve(this.storedOptions[t]):c.queryConfig(t).then(function(r){return e.storedOptions[t]=r.data,e.storedOptions[t]})},getAllStoredOptions:function(t){var e=this,r={};return o.all(_.map(t,e.getStoredOptions.bind(e))).then(function(){return _.each(t,function(t){r[t]=e.storedOptions[t]}),r})},suggest:function(t,e){var r={"partial-q":t,format:"json",options:_.isString(e)&&e||this.getSuggestOptions()||this.getQueryOptions()},n=this.getCombinedQuerySync();return _.isObject(e)&&(n.search.options=e),c.suggest(r,n).then(function(t){return t.data})},valuesFromConstraint:function(t,e){var r=this;return this.getStoredOptions().then(function(n){var i=s(n,t);if(!i)return o.reject(new Error("No constraint exists matching "+t));if(i.range&&(i.range.bucket||i.range["computed-bucket"]))return o.reject(new Error("Can't get values for bucketed constraint "+t));if(i.custom)return o.reject(new Error("Can't get values for custom constraint "+t));var u=a(i);return r.values(t,e,u)})},values:function(t,e,r){var n=this,s=this.getCombinedQuerySync();return r||!e||!e.options||e.start||e.limit||(r=e,e=null),e=e||{},e.start=void 0!==e.start?e.start:1,e.limit=void 0!==e.limit?e.limit:20,e.options=n.getQueryOptions(),_.isObject(r)&&(s.search.options=r),c.values(t,e,s).then(function(t){return t.data})},search:function(t){var e=this,r={start:this.start,pageLength:this.getPageLength(),transform:this.getTransform(),options:this.getQueryOptions()};if(t){var n=this.getCombinedQuerySync();t.search?n.search=t.search:t.options?n.search.options=t.options:t.query?n.search.query=t.query:n.search.options=t}else r.structuredQuery=this.getQuery(),r.q=this.getText();return c.search(r,n).then(function(t){var r=t.data;return n||(e.results=r),e.transformMetadata(r.results),e.annotateActiveFacets(r.facets),e.options.includeAggregates?e.getAggregates(r.facets).then(function(){return r}):r})},annotateActiveFacets:function(t){var e=this;_.forIn(t,function(t,r){var n=e.activeFacets[r];n&&_.chain(t.facetValues).filter(function(t){return e.isFacetActive(r,t.name)}).each(function(n){t.selected=n.selected=!0,n.negated=e.isFacetNegated(r,n.name)}).value(),("bucketed"===t.type||"custom"===t.type)&&(t.displayingAll=!0)})},getAggregates:function(t){var e=this;return e.getStoredOptions().then(function(r){var n=[];try{_.forIn(t,function(t,i){var o=t.type,u=s(r,i);if(!u)throw new Error("No constraint exists matching "+i);var c=a(u);c.values.aggregate=[{apply:"count"},{apply:"min"},{apply:"max"}];var l=["xs:int","xs:unsignedInt","xs:long","xs:unsignedLong","xs:float","xs:double","xs:decimal"];_.contains(l,o)&&(c.values.aggregate=c.values.aggregate.concat([{apply:"sum"},{apply:"avg"}])),n.push(e.values(i,{start:1,limit:0},c).then(function(e){var r=e&&e["values-response"]&&e["values-response"]["aggregate-result"];_.each(r,function(e){t[e.name]=e._value})}))})}catch(i){return o.reject(i)}return o.all(n)})},transformMetadata:function(t){var e,r=this;return _.isArray(t)?void _.each(t,this.transformMetadata,r):(e=t.metadata,t.metadata={},void _.each(e,function(e){var n=_.without(_.keys(e),"metadata-type")[0],s=e["metadata-type"],a=e[n],i=null,o=null,u=null;u=n.replace(/^\{([^}]+)\}.*$/,"$1"),o=r.getNamespacePrefix(u),i=o?n.replace(/\{[^}]+\}/,o+":"):n,t.metadata[i]||(t.metadata[i]={"metadata-type":s,values:[]}),t.metadata[i].values.push(a)}))},getStructuredQuery:function(){return console.log("Warning, MLSearchContext.getStructuredQuery is deprecated, and will be removed in the next release!\nUse MLSearchContext.getQuery in it's place"),this.getQuery.apply(this,arguments)},serializeStructuredQuery:function(){return console.log("Warning, MLSearchContext.serializeStructuredQuery is deprecated, and will be removed in the next release!\nUse MLSearchContext.getParams in it's place"),this.getParams.apply(this,arguments)}})}();