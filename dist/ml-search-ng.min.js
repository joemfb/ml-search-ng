!function(){"use strict";function t(){return function(t){var e=[];for(var n in t)t[n].__key=n,e.push(t[n]);return e}}function e(){return function(t,e,n){return e=e||10,n=n||"...",t.length<=e||t.length-n.length<=e?t:String(t).substring(0,e-n.length)+n}}angular.module("ml.search",["ml.common"]).filter("object2Array",t).filter("truncate",e)}(),function(){"use strict";function t(){return{restrict:"A",transclude:!0,scope:{mlDuration:"="},link:e}}function e(t,e,r,s,a){t.$watch("mlDuration",function(e){e&&angular.extend(t,{duration:n(e)})}),a(t,function(t){e.append(t)})}function n(t){var e=["P(","(([0-9]*\\.?[0-9]*)Y)?","(([0-9]*\\.?[0-9]*)M)?","(([0-9]*\\.?[0-9]*)W)?","(([0-9]*\\.?[0-9]*)D)?",")?","(T","(([0-9]*\\.?[0-9]*)H)?","(([0-9]*\\.?[0-9]*)M)?","(([0-9]*\\.?[0-9]*)S)?",")?"],n=new RegExp(e.join("")),r=t.match(n);return{years:parseFloat(r[3])||null,months:parseFloat(r[5])||null,weeks:parseFloat(r[7])||null,days:parseFloat(r[9])||null,hours:parseFloat(r[12])||null,minutes:parseFloat(r[14])||null,seconds:parseFloat(r[16])||null,toString:function(){return t}}}angular.module("ml.search").directive("mlDuration",t)}(),function(){"use strict";function t(){return{restrict:"E",scope:{facets:"=",toggle:"&"},templateUrl:e}}function e(t,e){var n;return n=e.template?"inline"===e.template?"/templates/ml-facets-inline.html":e.template:"/templates/ml-facets.html"}angular.module("ml.search").directive("mlFacets",t)}(),function(){"use strict";function t(){return{restrict:"E",scope:{qtext:"=",search:"&",suggest:"&"},templateUrl:e,link:n}}function e(t,e){var n;return n=e.template?"fa"===e.template?"/templates/ml-input-fa.html":e.template:"/templates/ml-input.html"}function n(t){t.clear=function(){t.search({qtext:""})}}angular.module("ml.search").directive("mlInput",t)}(),function(){"use strict";function t(t){return r=t,{restrict:"E",replace:!0,transclude:!0,templateUrl:"/templates/ml-metrics.html",scope:{search:"=",showDuration:"=?"},link:e}}function e(t,e,r,s,a){void 0===t.showDuration&&(t.showDuration=!0),t.$watch("search",function(e){angular.extend(t,n(e))}),a(t,function(t){t.length&&e.replaceWith(t)})}function n(t){return{total:t.total,start:t.start,pageLength:t["page-length"],pageEnd:r.Math.min(t.start+t["page-length"]-1,t.total),metrics:t.metrics}}angular.module("ml.search").directive("mlMetrics",t);var r=null;t.$inject=["$window"]}(),function(){"use strict";function t(){return{restrict:"E",controller:"MLRemoteInputController",scope:{searchCtrl:"@",template:"@"},template:e}}function e(t,e){var n="";return e.template&&(n=' template="'+e.template+'"'),'<ml-input qtext="qtext" search="search(qtext)" suggest="suggest(val)"'+n+"></ml-input>"}function n(t,e,n,r,s){var a,i=r.newContext();t.qtext=s.input,s.initInput(t,i),t.$watch("searchCtrl",function(e){var n=a;e=e||"SearchCtrl",a=s.getPath(e),n&&a!==n&&t.search("")}),t.search=function(t){e.path(a),s.setInput(t)},t.suggest=function(t){return i=s.mlSearch||i,i.suggest(t).then(function(t){return t.suggestions||[]})}}angular.module("ml.search").directive("mlRemoteInput",t).controller("MLRemoteInputController",n),n.$inject=["$scope","$location","$route","MLSearchFactory","MLRemoteInputService"]}(),function(){"use strict";function t(){return{restrict:"E",scope:{results:"=",link:"&"},templateUrl:e,link:n}}function e(t,e){var n;return n=e.template?e.template:"/templates/ml-results.html"}function n(t,e,n){n.link||(t.link=function(t){return"/detail?uri="+t.result.uri}),t.$watch("results",function(e){_.each(e,function(e){e.link=t.link({result:e})})})}angular.module("ml.search").directive("mlResults",t)}(),function(){"use strict";function t(t){function e(t){n.callbacks.splice(t)}var n=this;n.input="",n.mlSearch=null,n.callbacks=[],n.setInput=function(t){n.input=t,_.each(n.callbacks,function(t){t(n.input)})},n.subscribe=function(t){var r=n.callbacks.length;return n.callbacks.push(t),function(){e(r)}},n.initInput=function(t,e){var r=n.subscribe(function(r){t.qtext=r,e=n.mlSearch||e});t.$on("destroy",r)},n.initCtrl=function(t,e,r,s){var a=n.subscribe(function(t){e.qtext!==t&&(e.qtext=t,s())});t.$on("$destroy",a),n.mlSearch=r,e.qtext.length&&!n.input.length?n.setInput(e.qtext):e.qtext=n.input},n.getPath=function(e){var n=_.where(t.routes,{controller:e}),r={originalPath:"/"};return 0===n.length?console.error("can	 find Search controller: "+e):(r=n[0],n.length>1&&console.log("multiple Search controller routes; choosing '"+r.originalPath+"'")),r.originalPath}}angular.module("ml.search").service("MLRemoteInputService",t),t.$inject=["$route"]}(),function(){"use strict";function t(t,n,r,s){return i=t,o=n,u=r,c=s,{newContext:function(t){return new e(t)}}}function e(t){this.qb=c,this.results={},this.storedOptions={},this.activeFacets={},this.namespaces={},this.boostQueries=[],this.searchTransform=null,this.qtext=null,this.start=1,this.options=_.merge(_.cloneDeep(this.defaults),t)}function n(t){return decodeURIComponent(t.replace(/\+/g,"%20"))}function r(t,e){function n(t){var e=document.createElement("a");return e.href=t,e.pathname}return n(t)===n(e)}function s(t,e){var n=_.where(t.options.constraint,{name:e})[0];return n.type=n.collection?"collection":n.custom?"custom":n.range.type,n}function a(){var t;return t=0===arguments.length?[]:1===arguments.length?Array.isArray(arguments[0])?arguments[0]:[arguments[0]]:[].slice.call(arguments)}var i=null,o=null,u=null,c=null;angular.module("ml.search").factory("MLSearchFactory",t),t.$inject=["$q","$location","MLRest","MLQueryBuilder"],angular.extend(e.prototype,{defaults:{queryOptions:"all",pageLength:10,snippet:"compact",sort:null,facetMode:"and",includeProperties:!1,params:{separator:":",qtext:"q",facets:"f",sort:"s",page:"p"}},getActiveFacets:function(){return this.activeFacets},getNamespacePrefix:function(t){return this.namespaces[t]},getNamespaceUri:function(t){return _.chain(this.namespaces).map(function(e,n){return t===e?n:void 0}).compact().valueOf()[0]},getNamespaces:function(){var t=[];return _.forIn(this.namespaces,function(e,n){t.push({prefix:e,uri:n})}),t},setNamespaces:function(t){return _.each(t,this.addNamespace,this),this},addNamespace:function(t){return this.namespaces[t.uri]=t.prefix,this},clearNamespaces:function(){return this.namespaces={},this},getBoostQueries:function(){return this.boostQueries},addBoostQuery:function(t){return this.boostQueries.push(t),this},clearBoostQueries:function(){return this.boostQueries=[],this},getTransform:function(){return this.searchTransform},setTransform:function(t){return this.searchTransform=t,this},getText:function(){return this.qtext},setText:function(t){return this.qtext=""!==t?t:null,this},getPage:function(){var t=Math.floor(this.start/this.options.pageLength)+1;return t},setPage:function(t){return this.start=1+(t-1)*this.options.pageLength,this},getQueryOptions:function(){return this.options.queryOptions},getPageLength:function(){return this.options.pageLength},setPageLength:function(t){return this.options.pageLength=t,this},getSnippet:function(){return this.options.snippet},setSnippet:function(t){return this.options.snippet=t,this},clearSnippet:function(){return this.options.snippet=this.defaults.snippet,this},getSort:function(){return this.options.sort},setSort:function(t){return this.options.sort=t,this},clearSort:function(){return this.options.sort=this.defaults.sort,this},getFacetMode:function(){return this.options.facetMode},setFacetMode:function(t){return this.options.facetMode=t,this},getParamsConfig:function(){return this.options.params},getQuery:function(){var t=c.and();return _.keys(this.activeFacets).length&&(t=this.getFacetQuery()),this.qtext&&(t=c.and(t,c.text(this.qtext))),this.boostQueries.length&&(t=c.boost(t,this.boostQueries)),this.options.includeProperties&&(t=c.or(t,c.properties(t))),t=c.query(t),this.options.sort&&t.query.queries.push(c.operator("sort",this.options.sort)),this.options.snippet&&t.query.queries.push(c.operator("results",this.options.snippet)),t},getFacetQuery:function(){var t,e=this,n=[],r={};return _.forIn(e.activeFacets,function(r,s){r.values.length&&(t=function(t){return c.constraint(r.type)(s,t)},"or"===e.options.facetMode?n.push(t(r.values)):n=n.concat(_.map(r.values,t)))}),r="or"===e.options.facetMode?c.or(r):c.and(n)},getCombinedQuery:function(){var t=i.defer(),e={query:this.getQuery()};return this.getStoredOptions(this.options.queryConfig).then(function(n){e.options=n,t.resolve(e)},function(e){t.reject(e)}),t.promise},isFacetActive:function(t,e){var n=this.activeFacets[t];return n&&_.contains(n.values,e)},selectFacet:function(t,e,n){/^"(.*)"$/.test(e)&&(e=e.replace(/^"(.*)"$/,"$1"));var r=this.activeFacets[t];return r&&!_.contains(r.values,e)?r.values.push(e):this.activeFacets[t]={type:n,values:[e]},this},clearFacet:function(t,e){var n=this.activeFacets[t];return n.values=_.filter(n.values,function(t){return t!==e}),n.values.length||delete this.activeFacets[t],this},toggleFacet:function(t,e){var n;return this.isFacetActive(t,e)?this.clearFacet(t,e):(n=this.results.facets[t].type,this.selectFacet(t,e,n)),this},clearAllFacets:function(){return this.activeFacets={},this},getParams:function(){var t=this.getPage(),e=[],n={};return e=this.getFacetParams(),e.length&&(n[this.options.params.facets]=e),t>1&&(n[this.options.params.page]=t),this.qtext&&(n[this.options.params.qtext]=this.qtext),this.options.sort&&(n[this.options.params.sort]=this.options.sort),n},getFacetParams:function(){var t=this,e=t.getFacetQuery(),n=[],r=[];return n=(e["or-query"]||e["and-query"]).queries,_.each(n,function(e){var n=e[_.keys(e)[0]],s=n["constraint-name"];_.each(n.value||n.uri,function(e){/\s+/.test(e)&&!/^"(.*)"$/.test(e)&&(e='"'+e+'"'),r.push(s+t.options.params.separator+e)})}),r},fromParams:function(t){var e,r,s,a,u=this,c=i.defer();return t=t||o.search(),e=t[this.options.params.qtext]||null,s=t[this.options.params.page],a=t[this.options.params.sort],r=t[this.options.params.facets],u.setText(e),s?(s=parseInt(s)||1,u.setPage(s)):this.options.params.page&&u.setPage(1),a&&u.setSort(n(a)),u.clearAllFacets(),r?u.results.facets?(u.fromFacetParam(r),c.resolve()):u.getStoredOptions().then(function(t){u.fromFacetParam(r,t),c.resolve()}):c.resolve(),c.promise},fromFacetParam:function(t,e){var r=this,i=_.map(a(t),n);_.each(i,function(t){var n=t.split(r.options.params.separator),a=n[0],i=n[1],o=null;e?o=s(e,a).type:r.results.facets?o=r.results.facets[a].type:console.error("don't have facets or options for '"+a+"', falling back to un-typed range queries"),r.selectFacet(a,i,o)})},locationChange:function(t,e){var n=i.defer(),s=r(t,e),a=_.isEqual(this.getParams(),o.search());return s&&!a?this.fromParams().then(n.resolve):n.reject(),n.promise},getStoredOptions:function(t){var e=this,n=i.defer();return t=t||e.options.queryOptions,e.storedOptions[t]?n.resolve(e.storedOptions[t]):u.queryConfig(t).then(function(r){e.storedOptions[t]=r.data,n.resolve(e.storedOptions[t])},function(t){n.reject(t)}),n.promise},getAllStoredOptions:function(t){var e=this,n=i.defer(),r={};return i.all(_.map(t,e.getStoredOptions)).then(function(){_.each(t,function(t){r[t]=e.storedOptions[t]}),n.resolve(r)}),n.promise},suggest:function(t){var e=i.defer(),n={search:{query:this.getQuery()}},r={"partial-q":t,format:"json",options:this.options.queryOptions};return u.suggest(r,n).then(function(t){e.resolve(t.data)},function(t){e.reject(t)}),e.promise},search:function(){var t=this,e=i.defer();return u.search({options:t.options.queryOptions,structuredQuery:t.getQuery(),start:t.start,pageLength:t.options.pageLength,transform:t.searchTransform}).then(function(n){t.results=n.data,t.transformMetadata(),t.annotateActiveFacets(),e.resolve(t.results)},function(t){e.reject(t)}),e.promise},annotateActiveFacets:function(t){var e=this;t=t||e.results.facets,_.forIn(t,function(t,n){var r=e.activeFacets[n];r&&_.chain(t.facetValues).filter(function(t){return _.contains(r.values,t.name)}).each(function(e){t.selected=e.selected=!0})})},transformMetadata:function(t){var e,n=this;return t=t||this.results.results,_.isArray(t)?void _.each(t,this.transformMetadata,n):(e=t.metadata,t.metadata={},void _.each(e,function(e){var r=_.without(_.keys(e),"metadata-type")[0],s=e["metadata-type"],a=e[r],i=null,o=null,u=null;u=r.replace(/^\{([^}]+)\}.*$/,"$1"),o=n.getNamespacePrefix(u),i=o?r.replace(/\{[^}]+\}/,o+":"):r,_.contains(t.metadata,r)||(t.metadata[i]={"metadata-type":s,values:[]}),t.metadata[i].values.push(a)}))},getStructuredQuery:function(){return this.getQuery()},serializeStructuredQuery:function(){return this.getParams()}})}();